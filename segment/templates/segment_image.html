{% extends "base.html" %}
{% load widget_tweaks%}

{%block title %} Selector de imatges {% endblock%}
{% block header%}  
    <script type="text/javascript">
    
        function select_row(id) {
            document.getElementById('id_selected_row').value = id;
        }


        $( document ).ready(function() {
            var platform='pc';
	        var start='';
            var stop='';
            var move='';        
            if (platform=='iOS' || platform=='Android') {
                start='touchstart';
                stop='touchend';
                move='touchmove';
            } else if (platform=='pc') {
                start='mousedown';
                stop='mouseup';
                move='mousemove';
            }
            var canvas;
            var ctx;

            var canvasOffset;
            var offsetX;
            var offsetY;

            var isDrawing = false;

            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");

            var imageObj = new Image();
            imageObj.onload = function() {
                canvas.width=imageObj.width*{{zoom}};
                canvas.height=imageObj.height*{{zoom}};
                ctx.scale({{zoom}}, {{zoom}});
                ctx.drawImage(imageObj, 0, 0);
            };
            imageObj.src = '/static/{{form.filename.value}}';
            ctx.lineWidth = 1;
            
            canvasOffset = $("#canvas").offset();
            offsetX = canvasOffset.left;
            offsetY = canvasOffset.top;

            $("#canvas").on(start, function (e) {
                handleMouseDown(e);
            }).on(stop, function(e) {
                handleMouseUp(e);
            }).on(move, function(e) {
                handleMouseMove(e);
            }).on('mouseout', function(e) {
                handleMouseOut(e);
            });



            var startX;
            var startY;

            function get_clientX(e) {
                if (platform=='iOS' || platform=='Android') {
                    return e.touches[0].clientX;
                } else if (platform=='pc') {
                    return e.clientX;
                }
            }

            function get_clientY(e) {
                if (platform=='iOS' || platform=='Android') {
                    return e.touches[0].clientY;
                } else if (platform=='pc') {
                    return e.clientY;
                }
            }

            function handleMouseUp(e) {
                e.preventDefault();
	            endX = parseInt(get_clientX(e) - offsetX + $(document).scrollLeft());
	            endY = parseInt(get_clientY(e) - offsetY + $(document).scrollTop());
	            isDrawing = false;
	            canvas.style.cursor = "default";	
                if (startX > endX) {
                    x = startX;
                    startX = endX;
                    endX = x;
                }
                if (startY > endY) {
                    y = startY;
                    startY = endY;
                    endY = y;
                }
                document.getElementById('id_x1').value = parseInt(startX/{{zoom}});
                document.getElementById('id_y1').value = parseInt(startY/{{zoom}});
                document.getElementById('id_x2').value = parseInt(endX/{{zoom}});
                document.getElementById('id_y2').value = parseInt(endY/{{zoom}});
                $('#myModal_Segment').modal('show');
            }

            function handleMouseMove(e) {
                    e.preventDefault();
		            var mouseX = parseInt(get_clientX(e) - offsetX + $(document).scrollLeft());
		            var mouseY = parseInt(get_clientY(e) - offsetY + $(document).scrollTop());	
                    ctx.clearRect(0, 0, canvas.width, canvas.height);		
                    ctx.drawImage(imageObj, 0, 0);
	                ctx.beginPath();
                    ctx.moveTo(0,mouseY/{{zoom}});
                    ctx.lineTo(canvas.width/{{zoom}},mouseY/{{zoom}});
                    ctx.moveTo(mouseX/{{zoom}},0);
                    ctx.lineTo(mouseX/{{zoom}},canvas.height/{{zoom}});           
                    if (isDrawing) {					
		                ctx.rect(startX/{{zoom}}, startY/{{zoom}}, (mouseX - startX)/{{zoom}}, (mouseY - startY)/{{zoom}});	
	                }	
		            ctx.stroke();	

            }

            function handleMouseDown(e) {
                e.preventDefault();
	            canvas.style.cursor = "crosshair";		
	            isDrawing = true
	            startX = parseInt(get_clientX(e) - offsetX + $(document).scrollLeft());
	            startY = parseInt(get_clientY(e) - offsetY + $(document).scrollTop());
            }

            function handleMouseOut(e) {
                e.preventDefault();
                ctx.clearRect(0, 0, canvas.width, canvas.height);		
                ctx.drawImage(imageObj, 0, 0);
            }
        });
    </script>

{%endblock%}

{%block content %}

<form role="form" id="id_form_segment_image" name="form_segment_image" action='/segment_image/' method="POST">
{% csrf_token %}
    <input type="hidden" id="id_selected_row" name="selected_row" value=""/>   
    <input type="hidden" id="id_image" name="image" value="{{id_image}}"/>
    <input type="hidden" id="id_zoom" name="zoom" value="{{zoom}}"/>

    <button type="submit" class="btn btn-default" id="id_btn_zoom_in" name="btn_zoom_in">
        <span class="glyphicon glyphicon-zoom-in"></span>
    </button>
    <button type="submit" class="btn btn-default" id="id_btn_zoom_out" name="btn_zoom_out">
        <span class="glyphicon glyphicon-zoom-out"></span>
    </button>
    <br/><br/>
    <div id="id_div_canvas">
        <canvas id="canvas" class="segmentation"></canvas>
    </div>
    <br/>

    {% if segments %}
        <h4>Segments</h4>
        <br/>
        
        <div class="table-responsive">
            <table class="table">
                <tr>
                    <th>Segment Image</th>
                    <th>Filename</th>
                    <th>Coord. 1</th>
                    <th>Coord. 2</th>
                    <th>Tags</th>
                    <th></th>
                </tr>
                {%for segment in segments %}
                    <tr>
                        <td><img class="media-object" src="/static/uploads/segments/segment_{{id_image}}_{{segment.id}}.jpg" style="max-width:70px;max-height:50px;"/></td>
                        <td>{{segment.filename}}</td>
                        <td>({{segment.x1}}, {{segment.y1}})</td>
                        <td>({{segment.x2}}, {{segment.y2}})</td>
                        <td>{% for tag in segment.tags.all %} {{tag}} {%endfor%}</td>
                        <td>       
                            <a href="/edit_segment/?id={{segment.id}}" class="btn btn-default" role="button"><span class="glyphicon glyphicon-pencil"></span></a>                    
                            <button type="submit" class="btn btn-default" id="id_btn_remove_segment" name="btn_remove_segment" onclick="if (confirm('Are you sure you want to remove this segment?')){select_row({{segment.id}}); return true;}else {return false;}">
                                <span class="glyphicon glyphicon-trash"></span>
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    {% endif %}
    
    <hr>
    <div class="row right">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal_GenerateImages">Generate Images</button>
        <a href="/limages/" class="btn btn-default" role="button">Back</a>
    </div>
    <br/><br/><br/><br/><br/><br/>



</form>


{% include "modal_segment_image.html" with form_segment=form_segment zoom=zoom id_image=id_image %}

{% include "modal_generate_images.html" with form_generate_images=form_generate_images zoom=zoom id_image=id_image%}



{% endblock %}

